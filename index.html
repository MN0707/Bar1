<html>
  <head>
    <title>Wikipedia Geosearch API Example</title>
  </head>
  <body>
    <h1>Wikipedia Geosearch API Example</h1>
    <ul id="pages">
      <li>Loading...</li>
    </ul>

    <script>
	navigator.geolocation.getCurrentPosition(function(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
		
      var url = "https://en.wikipedia.org/w/api.php"; 

      var params = {
        action: "query",
        generator: "geosearch",
        ggscoord: "41.388614|2.131245",
        ggsradius: "10000",
        ggslimit: "10",
        prop: "extracts|pageimages",
        exintro: "",
        explaintext: "",
        piprop: "thumbnail",
        pilimit: "max",
        format: "json"
      };
	  
	  params.gscoord=latitude+"|"+longitude
	  
	//window.alert(params.gscoord)
	
      url = url + "?origin=*";
      Object.keys(params).forEach(function(key){url += "&" + key + "=" + params[key];});

      fetch(url)
        .then(function(response){return response.json();})
        .then(function(response) {
          var pages = response.query.pages;
          var pagesList = document.getElementById("pages");
          pagesList.innerHTML = "";

          for (var place in pages) {
            var page = pages[pageId];
		if (page.thumbnail) {
		    var title = page.title;
		    var dist = page.dist; 
		    var lat = page.lat;
		    var lon = page.lon;
		    var pageLink = "https://en.wikipedia.org/wiki/" + title.replace(" ", "_");
		    var thumbnail = page.thumbnail.source;

		    var listItem = document.createElement("li");
		    var link = document.createElement("a");
		    link.href = pageLink; 
		    link.innerHTML = title + " - " + dist + " m ; " + '<a href="https://www.google.com/maps/search/?api=1&query=' + lat + ',' + lon + '" target="_blank">GoogleMaps</a>';
		    listItem.appendChild(link);

		    var image = document.createElement("img");
		    image.src = thumbnail;
		    listItem.appendChild(image);

		    pagesList.appendChild(listItem);
		}
          }
        })
        .catch(function(error){
          var pagesList = document.getElementById("pages");
          pagesList.innerHTML = "Error: " + error;
        });
		
		});
    </script>
  </body>
</html>
